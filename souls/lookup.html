<!DOCTYPE html>
<html lang="en" dir="ltr">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <meta http-equiv="content-language" content="en-EN" />

    <title>SoulCap - Look up</title>

    <script src='bignumber.min.js'></script>
    <script type="text/javascript" src="https://cdn.jsdelivr.net/gh/ethereum/web3.js@1.0.0-beta.34/dist/web3.min.js">  </script>

    <link rel="stylesheet" href="appearance/style.css" type="text/css" />
    <link rel="stylesheet" href="appearance/style-homepage.css" type="text/css" />


  </head>
  <body>
    <div class="content">
      <img src="../soulCapLogo5.png" height="207" width="780" />
    </div>

    <div class="content">
      <form class="lookupForm" id="soul_form">
        <h2>Soul Library</h2>
        <label for="idlookup">Soul ID</label>
        <input type="text" name="idlookup" placeholder="1234">
        <button type="submit" name="button" class="btn purple">look up</button>
      </form>
    </div>

    <div class="content">
      <div class="soulgrid" id="soulgrid">
        <!-- souls go here -->
       <!-- <div class="soulcard">
          <h3>soul title</h3>
          <div class="img-holder">
            <img src="https://i.imgur.com/spjbzVT.png" alt="alt text is name">
          </div>
          <h3>soul name</h3>
          <button type="button" name="transfer-button" onClick="toggleModal()" class="small-btn purple">üéÅ Send</button>
        </div> -->
      </div>
    </div>

    <!-- Modal Transfer Content -->
    <div class="modal">
      <div class="modal-content">
        <span class="close-button">√ó</span>
        <h1>Send your soul somewhere else.</h1>
        <form class="lookupForm" id="transfer_form">
          <label for="soul_number">Soul Number</label>
          <input type="number" name="soul_number" value="" id="soul_number_input">
          <br>
          <label for="address">Recipient Ethereum Address</label>
          <input type="text" id="to_Address" name="address" placeholder="0x123abc">
          <br>
          <button type="button" name="send_button" onClick="transfer_soul()">üì´ Submit</button>
        </form>
        <div id="send_result">
        </div>
      </div>
    </div>


    <script type="text/javascript">
    window.addEventListener('load', async () => {
      console.log("loaded page.");
        // Modern dapp browsers...
        if (window.ethereum) {
            window.web3 = new Web3(ethereum);
            try {
                // Request account access if needed
                await ethereum.enable();
                // Acccounts now exposed
                console.log(ethereum.accounts[0]);
                const OWNER_ADDRESS = window.web3.givenProvider.selectedAddress; //window.web3.accounts[0];
                //web3.eth.sendTransaction({/* ... */});
            } catch (error) {
                // User denied account access...
            }
        }
        // Legacy dapp browsers...
        else if (window.web3) {
            window.web3 = new Web3(web3.currentProvider);
            // Acccounts always exposed
            //web3.eth.sendTransaction({/* ... */});
            console.log("current provider being used");
        }
        // Non-dapp browsers...
        else {
            console.log('Non-Ethereum browser detected. You should consider trying MetaMask!');
        }
    });



      //connect function for button press
      //web3 lookup souls(idlookup.value)
      //render new card of that soul

      const NFT_CONTRACT_ADDRESS = "0xb52e21ca2e6d46832551b45eb60a63b0987d0c7a";
      const NFT_ABI = [ { "constant": true, "inputs": [ { "name": "interfaceId", "type": "bytes4" } ], "name": "supportsInterface", "outputs": [ { "name": "", "type": "bool" } ], "payable": false, "stateMutability": "view", "type": "function", "signature": "0x01ffc9a7" }, { "constant": true, "inputs": [ { "name": "tokenId", "type": "uint256" } ], "name": "getApproved", "outputs": [ { "name": "", "type": "address" } ], "payable": false, "stateMutability": "view", "type": "function", "signature": "0x081812fc" }, { "constant": false, "inputs": [ { "name": "to", "type": "address" }, { "name": "tokenId", "type": "uint256" } ], "name": "approve", "outputs": [], "payable": false, "stateMutability": "nonpayable", "type": "function", "signature": "0x095ea7b3" }, { "constant": false, "inputs": [ { "name": "from", "type": "address" }, { "name": "to", "type": "address" }, { "name": "tokenId", "type": "uint256" } ], "name": "transferFrom", "outputs": [], "payable": false, "stateMutability": "nonpayable", "type": "function", "signature": "0x23b872dd" }, { "constant": true, "inputs": [ { "name": "", "type": "address" } ], "name": "captures_tracker", "outputs": [ { "name": "", "type": "uint256" } ], "payable": false, "stateMutability": "view", "type": "function", "signature": "0x3614822e" }, { "constant": false, "inputs": [ { "name": "from", "type": "address" }, { "name": "to", "type": "address" }, { "name": "tokenId", "type": "uint256" } ], "name": "safeTransferFrom", "outputs": [], "payable": false, "stateMutability": "nonpayable", "type": "function", "signature": "0x42842e0e" }, { "constant": true, "inputs": [ { "name": "tokenId", "type": "uint256" } ], "name": "ownerOf", "outputs": [ { "name": "", "type": "address" } ], "payable": false, "stateMutability": "view", "type": "function", "signature": "0x6352211e" }, { "constant": true, "inputs": [ { "name": "owner", "type": "address" } ], "name": "balanceOf", "outputs": [ { "name": "", "type": "uint256" } ], "payable": false, "stateMutability": "view", "type": "function", "signature": "0x70a08231" }, { "constant": true, "inputs": [ { "name": "", "type": "uint256" } ], "name": "souls", "outputs": [ { "name": "body", "type": "address" }, { "name": "name", "type": "string" }, { "name": "uri", "type": "string" }, { "name": "soul_type", "type": "uint64" } ], "payable": false, "stateMutability": "view", "type": "function", "signature": "0x7f0df684" }, { "constant": false, "inputs": [ { "name": "to", "type": "address" }, { "name": "approved", "type": "bool" } ], "name": "setApprovalForAll", "outputs": [], "payable": false, "stateMutability": "nonpayable", "type": "function", "signature": "0xa22cb465" }, { "constant": false, "inputs": [ { "name": "from", "type": "address" }, { "name": "to", "type": "address" }, { "name": "tokenId", "type": "uint256" }, { "name": "_data", "type": "bytes" } ], "name": "safeTransferFrom", "outputs": [], "payable": false, "stateMutability": "nonpayable", "type": "function", "signature": "0xb88d4fde" }, { "constant": true, "inputs": [ { "name": "owner", "type": "address" }, { "name": "operator", "type": "address" } ], "name": "isApprovedForAll", "outputs": [ { "name": "", "type": "bool" } ], "payable": false, "stateMutability": "view", "type": "function", "signature": "0xe985e9c5" }, { "inputs": [], "payable": false, "stateMutability": "nonpayable", "type": "constructor", "signature": "constructor" }, { "anonymous": false, "inputs": [ { "indexed": false, "name": "_holder", "type": "address" }, { "indexed": false, "name": "_bal", "type": "uint256" }, { "indexed": false, "name": "_result", "type": "bool" } ], "name": "zrxChecked", "type": "event", "signature": "0x1b6aa5a2f963e1ecb5ef4843bf43e348bf842f1f14a03fd9310bbfdc2dbf7f3d" }, { "anonymous": false, "inputs": [ { "indexed": false, "name": "_from", "type": "address" }, { "indexed": false, "name": "_name", "type": "string" }, { "indexed": false, "name": "_id", "type": "uint256" }, { "indexed": false, "name": "_uri", "type": "string" }, { "indexed": false, "name": "_value", "type": "uint256" } ], "name": "Capped", "type": "event", "signature": "0x863d47942dde95dfdcf03c518c18c1498143b944f7a302e00063e1d0ce12d679" }, { "anonymous": false, "inputs": [ { "indexed": false, "name": "_amount", "type": "uint256" }, { "indexed": false, "name": "_fee", "type": "uint256" } ], "name": "Paid", "type": "event", "signature": "0xef53713ee4f072f79f4d516084e3f4d15f2cde709d2091235b37ae719c272dd6" }, { "anonymous": false, "inputs": [ { "indexed": false, "name": "_have", "type": "uint256" }, { "indexed": false, "name": "_of", "type": "uint256" } ], "name": "MaxCount", "type": "event", "signature": "0xb5222a096b8e4b7ec78aac61715e8996fcee833db147b39b099c906c49a647e7" }, { "anonymous": false, "inputs": [ { "indexed": true, "name": "from", "type": "address" }, { "indexed": true, "name": "to", "type": "address" }, { "indexed": true, "name": "tokenId", "type": "uint256" } ], "name": "Transfer", "type": "event", "signature": "0xddf252ad1be2c89b69c2b068fc378daa952ba7f163c4a11628f55a4df523b3ef" }, { "anonymous": false, "inputs": [ { "indexed": true, "name": "owner", "type": "address" }, { "indexed": true, "name": "approved", "type": "address" }, { "indexed": true, "name": "tokenId", "type": "uint256" } ], "name": "Approval", "type": "event", "signature": "0x8c5be1e5ebec7d5bd14f71427d1e84f3dd0314c0f7b2291e5b200ac8c7c3b925" }, { "anonymous": false, "inputs": [ { "indexed": true, "name": "owner", "type": "address" }, { "indexed": true, "name": "operator", "type": "address" }, { "indexed": false, "name": "approved", "type": "bool" } ], "name": "ApprovalForAll", "type": "event", "signature": "0x17307eab39ab6107e8899845ad3d59bd9653f200f220920489ca2b5937696c31" }, { "constant": false, "inputs": [ { "name": "user", "type": "address" } ], "name": "hasZRX", "outputs": [ { "name": "", "type": "bool" } ], "payable": false, "stateMutability": "nonpayable", "type": "function", "signature": "0x76b53c6a" }, { "constant": false, "inputs": [ { "name": "_to", "type": "address" }, { "name": "_name", "type": "string" }, { "name": "_URI", "type": "string" }, { "name": "_type", "type": "uint64" } ], "name": "captureSoul", "outputs": [], "payable": true, "stateMutability": "payable", "type": "function", "signature": "0xb4497861" }, { "constant": false, "inputs": [ { "name": "_id", "type": "uint256" }, { "name": "_name", "type": "string" } ], "name": "setName", "outputs": [], "payable": false, "stateMutability": "nonpayable", "type": "function", "signature": "0xfe55932a" }, { "constant": false, "inputs": [ { "name": "_itemId", "type": "uint256" }, { "name": "_to", "type": "address" } ], "name": "tradeSoul", "outputs": [], "payable": true, "stateMutability": "payable", "type": "function", "signature": "0x6cc0370f" }, { "constant": false, "inputs": [ { "name": "_payto", "type": "address" } ], "name": "cashout", "outputs": [], "payable": false, "stateMutability": "nonpayable", "type": "function", "signature": "0x4846ff7e" }, { "constant": false, "inputs": [ { "name": "erc20_contracts", "type": "address[]" } ], "name": "withdraw", "outputs": [ { "name": "result", "type": "bool" } ], "payable": false, "stateMutability": "nonpayable", "type": "function", "signature": "0xbd5dec98" }, { "constant": false, "inputs": [ { "name": "_transfer_percent_fee", "type": "uint256" }, { "name": "_minting_fee_wei", "type": "uint256" }, { "name": "_ZRX_erc20_contrct", "type": "address" }, { "name": "_ZRX_discount_percent", "type": "uint16" }, { "name": "_max_souls_per_body", "type": "uint256" } ], "name": "setEverything", "outputs": [], "payable": false, "stateMutability": "nonpayable", "type": "function", "signature": "0x115fa416" } ];



      const soulform = document.getElementById('soul_form');
      const soulgrid = document.getElementById('soulgrid');
      const soulInput = soulform.elements['idlookup'];

      //function that creates new soul html elements give soul = {"image": "img uri","name": "soul name"}

      const appendNewSoul = function(soul) {
        console.log("adding soul: ", soul);
        const newListItem = document.createElement('div'); //${soul.image}
        newListItem.className = "soulcard";
        newListItem.innerHTML =  '<h3>Soul Number ' + soul.id + '</h3><br><div class="img-holder"><img class="soul_img" src="' + soul.image + '" alt="'+ soul.name + '"></div><h3>' + soul.name + '</h3>' + '  <button type="button" name="transfer-button" onClick="toggleModal(' + soul.id + ')" class="small-btn purple">üéÅ Send</button>';
        soulgrid.appendChild(newListItem);
      }

      //catch button presses and read from form current value
      soulform.onsubmit = function(event) {
        // stop our form submission from refreshing the page
        event.preventDefault();
        const OWNER_ADDRESS = window.web3.givenProvider.selectedAddress;
        //console.log("owner = ", OWNER_ADDRESS);

        // get soul value and add it to the list.
        //console.log("id = ", soulInput.value);
        const lookup_id = soulInput.value;
        var web3 = new Web3(ethereum);
        const soulContract = new web3.eth.Contract(NFT_ABI, NFT_CONTRACT_ADDRESS);
        var rawSoul = {"image": "https://i.imgur.com/spjbzVT.png", "name": "soul name", "id":-1};

        soulContract.methods.souls(soulInput.value).call({from: OWNER_ADDRESS}).then(function(result) {
            //console.log("result: ", result);
            if(result[0] == "0x0000000000000000000000000000000000000000"){
              //TODO display popup that it didnt work
            }else{
              rawSoul["image"] = result[2];
              rawSoul["name"] = result[1];
              rawSoul["id"] = Number(lookup_id);
              appendNewSoul(rawSoul);
            }
        });

        // reset form
        soulInput.value = '';
        soulInput.focus();
      };

      var modal = document.querySelector(".modal");
      var closeButton = document.querySelector(".close-button");

      //every transfer button on every card starts this function.
      function toggleModal(soul_id) {
          modal.classList.toggle("show-modal");
          id_input = document.getElementById('soul_number_input');
          id_input.value = soul_id;
      }

      //Close modal with x button
      function toggleModalOff(){
         modal.classList.toggle("show-modal");
      }

      // Main transer function, which makes web3 call to actually move token
      function transfer_soul(){
        const id_input = document.getElementById('soul_number_input').value;
        const to_address = document.getElementById('to_Address').value;
        //console.log(id_input);

        // stop our form submission from refreshing the page
        event.preventDefault();

        const OWNER_ADDRESS = window.web3.givenProvider.selectedAddress;
        //new instance of contract needed.
        ethereum.enable();
        var web3 = new Web3(ethereum);
        const soulContract = new web3.eth.Contract(NFT_ABI, NFT_CONTRACT_ADDRESS, { gasLimit: "1000000" });

        //make transfer call with user input address and ID
        soulContract.methods.tradeSoul(id_input, to_address).send({from: OWNER_ADDRESS, value: 0}).then(function(result) {
          console.log("transfer result: ", result);
          //let the user know where to confirm
          var output = document.getElementById('send_result');

          //TODO better error handle for when transfer fails
          if (result) {
            output.innerHTML = "Soul Sent! Check out https://etherscan.io/tx/" + result.transactionHash;
          }else{
              output.innerHTML = "Send Failed. Perhaps you dont own that soul?";
          }
        });
      }

      // Allow close button to close modal popup
      closeButton.addEventListener("click", toggleModalOff);

    </script>
  </body>
</html>
